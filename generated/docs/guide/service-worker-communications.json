{
  "id": "guide/service-worker-communications",
  "title": "Service worker communication",
  "contents": "\n\n\n\n\n<div class=\"content\">\n  <h1 id=\"service-worker-communication\">Service worker communication<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#service-worker-communication\"><i class=\"material-icons\">link</i></a></h1>\n<p>Enabling service worker support does more than just register the service worker; it also provides services you can use to interact with the service worker and control the caching of your application.</p>\n<h2 id=\"prerequisites\">Prerequisites<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#prerequisites\"><i class=\"material-icons\">link</i></a></h2>\n<p>A basic understanding of the following:</p>\n<ul>\n<li><a href=\"guide/service-worker-getting-started\">Getting Started with Service Workers</a></li>\n</ul>\n<h2 id=\"swupdate-service\"><code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> service<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#swupdate-service\"><i class=\"material-icons\">link</i></a></h2>\n<p>The <code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> service gives you access to events that indicate when the service worker discovers and installs an available update for your application.</p>\n<p>The <code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> service supports three separate operations:</p>\n<ul>\n<li>Get notified when an updated version is <em>detected</em> on the server, <em>installed and ready</em> to be used locally or when an <em>installation fails</em></li>\n<li>Ask the service worker to check the server for new updates</li>\n<li>Ask the service worker to activate the latest version of the application for the current tab</li>\n</ul>\n<h3 id=\"version-updates\">Version updates<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#version-updates\"><i class=\"material-icons\">link</i></a></h3>\n<p>The <code>versionUpdates</code> is an <code>Observable</code> property of <code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> and emits four event types:</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Event types</th>\n<th align=\"left\">Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\"><code><a href=\"api/service-worker/VersionDetectedEvent\" class=\"code-anchor\">VersionDetectedEvent</a></code></td>\n<td align=\"left\">Emitted when the service worker has detected a new version of the app on the server and is about to start downloading it.</td>\n</tr>\n<tr>\n<td align=\"left\"><code><a href=\"api/service-worker/NoNewVersionDetectedEvent\" class=\"code-anchor\">NoNewVersionDetectedEvent</a></code></td>\n<td align=\"left\">Emitted when the service worker has checked the version of the app on the server and did not find a new version.</td>\n</tr>\n<tr>\n<td align=\"left\"><code><a href=\"api/service-worker/VersionReadyEvent\" class=\"code-anchor\">VersionReadyEvent</a></code></td>\n<td align=\"left\">Emitted when a new version of the app is available to be activated by clients. It may be used to notify the user of an available update or prompt them to refresh the page.</td>\n</tr>\n<tr>\n<td align=\"left\"><code><a href=\"api/service-worker/VersionInstallationFailedEvent\" class=\"code-anchor\">VersionInstallationFailedEvent</a></code></td>\n<td align=\"left\">Emitted when the installation of a new version failed. It may be used for logging/monitoring purposes.</td>\n</tr>\n</tbody>\n</table>\n<code-example header=\"log-update.service.ts\" path=\"service-worker-getting-started/src/app/log-update.service.ts\" region=\"sw-update\">\n@<a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a>({providedIn: 'root'})\nexport class LogUpdateService {\n\n  constructor(updates: <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>) {\n    updates.versionUpdates.subscribe(evt => {\n      switch (evt.type) {\n        case 'VERSION_DETECTED':\n          console.log(`Downloading new app version: ${evt.version.hash}`);\n          break;\n        case 'VERSION_READY':\n          console.log(`Current app version: ${evt.currentVersion.hash}`);\n          console.log(`New app version ready for use: ${evt.latestVersion.hash}`);\n          break;\n        case 'VERSION_INSTALLATION_FAILED':\n          console.log(`Failed to install app version '${evt.version.hash}': ${evt.error}`);\n          break;\n      }\n    });\n  }\n}\n\n</code-example>\n<h3 id=\"checking-for-updates\">Checking for updates<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#checking-for-updates\"><i class=\"material-icons\">link</i></a></h3>\n<p>It's possible to ask the service worker to check if any updates have been deployed to the server.\nThe service worker checks for updates during initialization and on each navigation request â€”that is, when the user navigates from a different address to your application.\nHowever, you might choose to manually check for updates if you have a site that changes frequently or want updates to happen on a schedule.</p>\n<p>Do this with the <code>checkForUpdate()</code> method:</p>\n<code-example header=\"check-for-update.service.ts\" path=\"service-worker-getting-started/src/app/check-for-update.service.ts\">\nimport { <a href=\"api/core/ApplicationRef\" class=\"code-anchor\">ApplicationRef</a>, <a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a> } from '@angular/core';\nimport { <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a> } from '@angular/service-worker';\nimport { concat, interval } from 'rxjs';\nimport { first } from 'rxjs/operators';\n\n@<a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a>({providedIn: 'root'})\nexport class CheckForUpdateService {\n\n  constructor(appRef: <a href=\"api/core/ApplicationRef\" class=\"code-anchor\">ApplicationRef</a>, updates: <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>) {\n    // Allow the app to stabilize first, before starting\n    // polling for updates with `interval()`.\n    const appIsStable$ = appRef.isStable.pipe(first(isStable => isStable === true));\n    const everySixHours$ = interval(6 * 60 * 60 * 1000);\n    const everySixHoursOnceAppIsStable$ = concat(appIsStable$, everySixHours$);\n\n    everySixHoursOnceAppIsStable$.subscribe(<a href=\"api/platform-browser/animations/async\" class=\"code-anchor\">async</a> () => {\n      try {\n        const updateFound = await updates.checkForUpdate();\n        console.log(updateFound ? 'A new version is available.' : 'Already on the latest version.');\n      } catch (err) {\n        console.error('Failed to check for updates:', err);\n      }\n    });\n  }\n}\n\n\n</code-example>\n<p>This method returns a <code>Promise&#x3C;boolean></code> which indicates if an update is available for activation.\nThe check might fail, which will cause a rejection of the <code>Promise</code>.</p>\n<div class=\"alert is-important\">\n<p>In order to avoid negatively affecting the initial rendering of the page, by default the Angular service worker service waits for up to 30 seconds for the application to stabilize before registering the ServiceWorker script.\nConstantly polling for updates, for example, with <a href=\"https://developer.mozilla.org/docs/Web/API/WindowOrWorkerGlobalScope/setInterval\">setInterval()</a> or RxJS' <a href=\"https://rxjs.dev/api/index/function/interval\">interval()</a>, prevents the application from stabilizing and the ServiceWorker script is not registered with the browser until the 30 seconds upper limit is reached.</p>\n<div class=\"alert is-helpful\">\n<p><strong>NOTE</strong>: <br>\nThis is true for any kind of polling done by your application.\nCheck the <a href=\"api/core/ApplicationRef#isStable\">isStable</a> documentation for more information.</p>\n</div>\n<p>Avoid that delay by waiting for the application to stabilize first, before starting to poll for updates, as shown in the preceding example.\nAlternatively, you might want to define a different <a href=\"api/service-worker/SwRegistrationOptions#registrationStrategy\">registration strategy</a> for the ServiceWorker.</p>\n</div>\n<h3 id=\"updating-to-the-latest-version\">Updating to the latest version<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#updating-to-the-latest-version\"><i class=\"material-icons\">link</i></a></h3>\n<p>You can update an existing tab to the latest version by reloading the page as soon as a new version is ready.\nTo avoid disrupting the user's progress, it is generally a good idea to prompt the user and let them confirm that it is OK to reload the page and update to the latest version:</p>\n<code-example header=\"prompt-update.service.ts\" path=\"service-worker-getting-started/src/app/prompt-update.service.ts\" region=\"sw-version-ready\">\n@<a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a>({providedIn: 'root'})\nexport class PromptUpdateService {\n\n  constructor(swUpdate: <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>) {\n    swUpdate.versionUpdates\n        .pipe(filter((evt): evt is <a href=\"api/service-worker/VersionReadyEvent\" class=\"code-anchor\">VersionReadyEvent</a> => evt.type === 'VERSION_READY'))\n        .subscribe(evt => {\n          if (promptUser(evt)) {\n            // Reload the page to update to the latest version.\n            document.location.reload();\n          }\n        });\n  }\n\n}\n\n</code-example>\n<div class=\"alert is-important\">\n<p>Calling <a href=\"api/service-worker/SwUpdate#activateUpdate\"><code>SwUpdate#activateUpdate</code></a> updates a tab to the latest version without reloading the page, but this could break the application.</p>\n<p>Updating without reloading can create a version mismatch between the <a href=\"guide/glossary#app-shell\">application shell</a> and other page resources, such as <a href=\"guide/glossary#lazy-loading\">lazy-loaded chunks</a>, whose filenames may change between versions.</p>\n<p>You should only use <code>activateUpdate()</code>, if you are certain it is safe for your specific use case.</p>\n</div>\n<h3 id=\"handling-an-unrecoverable-state\">Handling an unrecoverable state<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#handling-an-unrecoverable-state\"><i class=\"material-icons\">link</i></a></h3>\n<p>In some cases, the version of the application used by the service worker to serve a client might be in a broken state that cannot be recovered from without a full page reload.</p>\n<p>For example, imagine the following scenario:</p>\n<ul>\n<li>\n<p>A user opens the application for the first time and the service worker caches the latest version of the application.\nAssume the application's cached assets include <code>index.html</code>, <code>main.&#x3C;main-hash-1>.js</code> and <code>lazy-chunk.&#x3C;lazy-hash-1>.js</code>.</p>\n</li>\n<li>\n<p>The user closes the application and does not open it for a while.</p>\n</li>\n<li>\n<p>After some time, a new version of the application is deployed to the server.\nThis newer version includes the files <code>index.html</code>, <code>main.&#x3C;main-hash-2>.js</code> and <code>lazy-chunk.&#x3C;lazy-hash-2>.js</code>.</p>\n<div class=\"alert is-helpful\">\n<p><strong>NOTE</strong>: <br>\nThe hashes are different now, because the content of the files changed.</p>\n</div>\n<p>The old version is no longer available on the server.</p>\n</li>\n<li>\n<p>In the meantime, the user's browser decides to evict <code>lazy-chunk.&#x3C;lazy-hash-1>.js</code> from its cache.\nBrowsers might decide to evict specific (or all) resources from a cache in order to reclaim disk space.</p>\n</li>\n<li>\n<p>The user opens the application again.\nThe service worker serves the latest version known to it at this point, namely the old version (<code>index.html</code> and <code>main.&#x3C;main-hash-1>.js</code>).</p>\n</li>\n<li>\n<p>At some later point, the application requests the lazy bundle, <code>lazy-chunk.&#x3C;lazy-hash-1>.js</code>.</p>\n</li>\n<li>\n<p>The service worker is unable to find the asset in the cache (remember that the browser evicted it).\nNor is it able to retrieve it from the server (because the server now only has <code>lazy-chunk.&#x3C;lazy-hash-2>.js</code> from the newer version).</p>\n</li>\n</ul>\n<p>In the preceding scenario, the service worker is not able to serve an asset that would normally be cached.\nThat particular application version is broken and there is no way to fix the state of the client without reloading the page.\nIn such cases, the service worker notifies the client by sending an <code><a href=\"api/service-worker/UnrecoverableStateEvent\" class=\"code-anchor\">UnrecoverableStateEvent</a></code> event.\nSubscribe to <code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>#unrecoverable</code> to be notified and handle these errors.</p>\n<code-example header=\"handle-unrecoverable-state.service.ts\" path=\"service-worker-getting-started/src/app/handle-unrecoverable-state.service.ts\" region=\"sw-unrecoverable-state\">\n@<a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a>({providedIn: 'root'})\nexport class HandleUnrecoverableStateService {\n  constructor(updates: <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>) {\n    updates.unrecoverable.subscribe(event => {\n      notifyUser(\n        'An error occurred that we cannot recover from:\\n' +\n        event.reason +\n        '\\n\\nPlease reload the page.'\n      );\n    });\n  }\n}\n\n</code-example>\n<h2 id=\"more-on-angular-service-workers\">More on Angular service workers<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#more-on-angular-service-workers\"><i class=\"material-icons\">link</i></a></h2>\n<p>You might also be interested in the following:</p>\n<ul>\n<li><a href=\"guide/service-worker-notifications\">Service Worker Notifications</a></li>\n</ul>\n<!-- links -->\n<!-- external links -->\n<!-- end links -->\n\n  <div class=\"reviewed\">Last reviewed on Mon Feb 28 2022</div>\n</div>\n\n<!-- links to this doc:\n - api/service-worker/NoNewVersionDetectedEvent\n - api/service-worker/SwUpdate\n - api/service-worker/UnrecoverableStateEvent\n - api/service-worker/VersionDetectedEvent\n - api/service-worker/VersionInstallationFailedEvent\n - api/service-worker/VersionReadyEvent\n - guide/service-worker-devops\n - guide/service-worker-getting-started\n - guide/service-worker-intro\n-->\n<!-- links from this doc:\n - api/core/ApplicationRef\n - api/core/ApplicationRef#isStable\n - api/core/Injectable\n - api/platform-browser/animations/async\n - api/service-worker/NoNewVersionDetectedEvent\n - api/service-worker/SwRegistrationOptions#registrationStrategy\n - api/service-worker/SwUpdate\n - api/service-worker/SwUpdate#activateUpdate\n - api/service-worker/UnrecoverableStateEvent\n - api/service-worker/VersionDetectedEvent\n - api/service-worker/VersionInstallationFailedEvent\n - api/service-worker/VersionReadyEvent\n - guide/glossary#app-shell\n - guide/glossary#lazy-loading\n - guide/service-worker-communications#checking-for-updates\n - guide/service-worker-communications#handling-an-unrecoverable-state\n - guide/service-worker-communications#more-on-angular-service-workers\n - guide/service-worker-communications#prerequisites\n - guide/service-worker-communications#service-worker-communication\n - guide/service-worker-communications#swupdate-service\n - guide/service-worker-communications#updating-to-the-latest-version\n - guide/service-worker-communications#version-updates\n - guide/service-worker-getting-started\n - guide/service-worker-notifications\n - https://developer.mozilla.org/docs/Web/API/WindowOrWorkerGlobalScope/setInterval\n - https://rxjs.dev/api/index/function/interval\n-->"
}